---
clusterName: invertedorigin

# renovate: datasource=github-releases depName=siderolabs/talos
talosVersion: v1.6.2

# renovate: datasource=github-releases depName=kubernetes/kubernetes
kubernetesVersion: v1.28.4

endpoint: https://node-1.tail7ebe0.ts.net:6443

allowSchedulingOnMasters: true
allowSchedulingOnControlPlanes: true

additionalApiServerCertSans: []

additionalMachineCertSans: []

clusterPodNets:
  - 10.244.0.0/16
clusterSvcNets:
  - 10.245.0.0/16

cniConfig:
  name: none

talosImageURL: ghcr.io/jtcressy-home/installer

nodes:
## CORE HOME OFFICE RACK (battery backup) ##
  - hostname: node-1.tail7ebe0.ts.net
    ipAddress: node-1.tail7ebe0.ts.net
    controlPlane: true
    installDiskSelector:
      model: KINGSTON OM8PGP4512Q-A0
    disableSearchDomain: false
    nodeLabels:
      topology.kubernetes.io/region: home
  - hostname: node-2.tail7ebe0.ts.net
    ipAddress: node-2.tail7ebe0.ts.net
    controlPlane: true
    installDiskSelector:
      model: KINGSTON OM8PGP4512Q-A0
    disableSearchDomain: false
    nodeLabels:
      topology.kubernetes.io/region: home
  - hostname: node-3.tail7ebe0.ts.net
    ipAddress: node-3.tail7ebe0.ts.net
    controlPlane: true
    installDiskSelector:
      model: KINGSTON OM8PGP4512Q-A0
    disableSearchDomain: false
    nodeLabels:
      topology.kubernetes.io/region: home
patches:
  - |-
    machine:
      features:
        kubernetesTalosAPIAccess:
          enabled: true
          allowedRoles:
            - os:admin
          allowedKubernetesNamespaces:
            - system-upgrade
  - |
    machine:
      sysctls:
        net.core.rmem_max: 2500000
        net.core.wmem_max: 2500000
  - |
    machine:
      kernel:
        modules:
          - name: drbd
            parameters:
              - usermode_helper=disabled
          - name: drbd_transport_tcp
  - |
    machine:
      files:
        - content: |
            TS_AUTHKEY=${TAILSCALE_AUTHKEY}
            TS_ACCEPT_DNS=true
          permissions: 0o644
          path: /var/etc/tailscale/auth.env
          op: create
        - content: |
            [plugins."io.containerd.grpc.v1.cri"]
              enable_unprivileged_ports = true
              enable_unprivileged_icmp = true
          path: /etc/cri/conf.d/20-customization.part
          op: create
      kubelet:
        nodeIP:
          validSubnets:
            - 100.64.0.0/10
      features:
        kubePrism:
          enabled: true
          port: 7445
      network:
        nameservers:
          - 100.100.100.100
          - 1.1.1.1
controlPlane:
  patches:
    - |
      cluster:
        allowSchedulingOnMasters: true
        apiServer:
          admissionControl: null
        discovery:
          enabled: true
          registries:
            kubernetes:
              disabled: true
            service: {}
        etcd:
          advertisedSubnets:
            - 100.64.0.0/10 # we want etcd to talk over tailscale for stable network paths
        proxy:
          disabled: true
