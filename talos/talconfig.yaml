---
clusterName: invertedorigin

# renovate: datasource=github-releases depName=siderolabs/talos
talosVersion: v1.7.4

# renovate: datasource=github-releases depName=kubernetes/kubernetes
kubernetesVersion: v1.30.1

endpoint: https://node-1.tail7ebe0.ts.net:6443

allowSchedulingOnMasters: true
allowSchedulingOnControlPlanes: true

additionalApiServerCertSans: []

additionalMachineCertSans: []

clusterPodNets:
  - 10.244.0.0/16
clusterSvcNets:
  - 10.245.0.0/16

cniConfig:
  name: none

nodes:
## CORE HOME OFFICE RACK (battery backup) ##
  - hostname: node-1.tail7ebe0.ts.net
    talosImageURL: factory.talos.dev/installer/859dd30ac3e1f9f0aa5e425e347525e0090e0d2329517ee2f52754c82e680c7f
    ipAddress: node-1.tail7ebe0.ts.net
    controlPlane: true
    installDiskSelector:
      model: KINGSTON OM8PGP4512Q-A0
    disableSearchDomain: false
    nodeLabels:
      topology.kubernetes.io/region: home
    machineDisks:
      - device: /dev/sda
        partitions:
          - mountpoint: /var/mnt/sata-ssd
    extensionServices:
    - name: tailscale
      environment:
        - TS_AUTH_KEY=${TAILSCALE_AUTHKEY}
        - TS_ACCEPT_DNS=true
  - hostname: node-2.tail7ebe0.ts.net
    talosImageURL: factory.talos.dev/installer/859dd30ac3e1f9f0aa5e425e347525e0090e0d2329517ee2f52754c82e680c7f
    ipAddress: node-2.tail7ebe0.ts.net
    controlPlane: true
    installDiskSelector:
      model: KINGSTON OM8PGP4512Q-A0
    disableSearchDomain: false
    nodeLabels:
      topology.kubernetes.io/region: home
    machineDisks:
      - device: /dev/sda
        partitions:
          - mountpoint: /var/mnt/sata-ssd
    extensionServices:
    - name: tailscale
      environment:
        - TS_AUTH_KEY=${TAILSCALE_AUTHKEY}
        - TS_ACCEPT_DNS=true
  - hostname: node-3.tail7ebe0.ts.net
    talosImageURL: factory.talos.dev/installer/859dd30ac3e1f9f0aa5e425e347525e0090e0d2329517ee2f52754c82e680c7f
    ipAddress: node-3.tail7ebe0.ts.net
    controlPlane: true
    installDiskSelector:
      model: KINGSTON OM8PGP4512Q-A0
    disableSearchDomain: false
    nodeLabels:
      topology.kubernetes.io/region: home
    machineDisks:
      - device: /dev/sda
        partitions:
          - mountpoint: /var/mnt/sata-ssd
    extensionServices:
    - name: tailscale
      environment:
        - TS_AUTH_KEY=${TAILSCALE_AUTHKEY}
        - TS_ACCEPT_DNS=true
patches:
  - |-
    machine:
      features:
        kubernetesTalosAPIAccess:
          enabled: true
          allowedRoles:
            - os:admin
          allowedKubernetesNamespaces:
            - system-upgrade
  - |
    machine:
      sysctls:
        net.core.rmem_max: 2500000
        net.core.wmem_max: 2500000
  - |
    machine:
      files:
        - content: |
            TS_AUTHKEY=${TAILSCALE_AUTHKEY}
            TS_ACCEPT_DNS=true
          permissions: 0o644
          path: /var/etc/tailscale/auth.env
          op: create
        - content: |
            [plugins."io.containerd.grpc.v1.cri"]
              enable_unprivileged_ports = true
              enable_unprivileged_icmp = true
          path: /etc/cri/conf.d/20-customization.part
          op: create
      kubelet:
        nodeIP:
          validSubnets:
            - 100.64.0.0/10
      features:
        kubePrism:
          enabled: true
          port: 7445
      network:
        nameservers:
          - 100.100.100.100
          - 1.1.1.1
controlPlane:
  patches:
    - |
      cluster:
        allowSchedulingOnMasters: true
        apiServer:
          admissionControl: null
        discovery:
          enabled: true
          registries:
            kubernetes:
              disabled: true
            service: {}
        etcd:
          advertisedSubnets:
            - 100.64.0.0/10 # we want etcd to talk over tailscale for stable network paths
        proxy:
          disabled: true
