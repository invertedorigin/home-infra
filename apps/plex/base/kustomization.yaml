apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- namespace.yaml
- pvc.yaml

namespace: plex

helmCharts:
- name: clusterplex
  repo: http://pabloromeo.github.io/clusterplex
  version: v1.1.7
  releaseName: clusterplex
  valuesInLine:
    global:
      sharedStorage:
        transcode:
          storageClass: ceph-filesystem
        media:
          storageClass: ceph-filesystem
        worker:
          storageClass: ceph-block
        additionalMediaVolumes:
          drivers:
            enabled: true
            existingClaim: plex-drivers
            mountPath: /config/Library/Application Support/Plex Media Server/Drivers

          cache:
            enabled: true
            existingClaim: plex-cache
            mountPath: /config/Library/Application Support/Plex Media Server/Cache
    pms:
      config:
        transcodeOperatingMode: remote
      configVolume:
          storageClass: ceph-block
      resources:
        requests:
          cpu: 2
          memory: 3Gi
          amd.com/gpu: 1
        limits:
          amd.com/gpu: 1
      ingressConfig:
          enabled: true
          annotations:
            kubernetes.io/ingress.class: "nginx"
            cert-manager.io/cluster-issuer: "cloudflare-issuer"
          hosts:
            - host: &host plex.invertedorigin.com
              paths:
                - path: /
                  pathType: Prefix
          tls:
            - hosts:
                - *host
              secretName: plexa-tls-domain
    worker:
      config:
        replicas: 2
      env:
        FFMPEG_HWACCEL: vaapi
      securityContext:
        privileged: true
      resources:
        requests:
          cpu: 2
          memory: 3Gi
          amd.com/gpu: 1
        limits:
          amd.com/gpu: 1
