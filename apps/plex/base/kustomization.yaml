apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- namespace.yaml
- pvc.yaml

namespace: plex

helmCharts:
- name: app-template
  repo: https://bjw-s.github.io/helm-charts/
  version: 3.2.1
  releaseName: plex
  valuesInline:
    controllers:
      plex:
        containers:
          app:
            image:
              repository: plexinc/pms-docker
              tag: 1.40.3.8555-fef15d30c
            env:
              TZ: America/Chicago
              PLEX_ADVERTISE_URL: https://plex.invertedorigin.com:443,http://10.0.1.7:32400
              PLEX_NO_AUTH_NETWORKS: 10.0.1.0/24
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /identity
                    port: 32400
                  initialDelaySeconds: 0
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
              readiness: *probes
              startup:
                enabled: true
                spec:
                  failureThreshold: 30
                  periodSeconds: 10
            # securityContext:
            #   allowPrivilegeEscalation: false
            #   readOnlyRootFilesystem: false
            #   capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 100m
              limits:
                amd.com/gpu: 1
    # defaultPodOptions:
    #   securityContext:
    #     runAsNonRoot: true
    #     runAsUser: 568
    #     runAsGroup: 568
    #     fsGroup: 568
    #     fsGroupChangePolicy: OnRootMismatch
    #     supplementalGroups: [44, 10000]
    #     seccompProfile: { type: RuntimeDefault }
    service:
      app:
        controller: plex
        type: LoadBalancer
        ports:
          http:
            port: 32400
    ingress:
      app:
        annotations:
          kubernetes.io/ingress.class: "nginx"
          cert-manager.io/cluster-issuer: "cloudflare-issuer"
        hosts:
          - host: &host plex.invertedorigin.com
            paths:
              - path: /
                service:
                  name: plex
                  port: 32400
        tls:
          - hosts:
              - *host
            secretName: plex-tls-domain
    persistence:
      config:
        existingClaim: plex
        globalMounts:
          - path: /config/Library/Application Support/Plex Media Server
      cache:
        existingClaim: plex-cache
        globalMounts:
          - path: /config/Library/Application Support/Plex Media Server/Cache
      logs:
        type: emptyDir
        globalMounts:
          - path: /config/Library/Application Support/Plex Media Server/Logs
      tmp:
        type: emptyDir
      transcode:
        type: emptyDir
      media:
        existingClaim: plex-media
        globalMounts:
          - path: /media
