apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: firefly

resources:
- namespace.yaml
- pg-cluster.yaml
- external-secret.yaml
- pod-monitor.yaml

helmCharts:
- name: firefly-iii
  repo: https://firefly-iii.github.io/kubernetes/
  version: 1.5.0
  releaseName: firefly-iii
  valuesInline:
    persistence:
      enabled: false

    config:
      existingSecret: "firefly-iii-secret"

      env:
        DB_CONNECTION: "pgsql"
        DB_HOST: "firefly-rw.firefly.svc.cluster.local"
        DB_PORT: "5432"
        DEFAULT_LANGUAGE: "en_US"
        DEFAULT_LOCALE: "equal"
        TZ: "America/Chicago"
        TRUSTED_PROXIES: "**"

    ingress:
      enabled: true
      className: "nginx"
      annotations:
        kubernetes.io/ingress.class: nginx
        cert-manager.io/cluster-issuer: cloudflare-issuer
        nginx.ingress.kubernetes.io/proxy-buffer-size: "16k"
      hosts:
        - &host firefly.invertedorigin.com
      tls:
       - secretName: firefly-tls-domain
         hosts:
           - *host

- name: importer
  repo: https://firefly-iii.github.io/kubernetes/
  version: 1.3.1
  releaseName: importer
  valuesInline:
    persistence:
      enabled: false

    fireflyiii:
      url: "https://firefly.invertedorigin.com"
    config:
      existingSecret: "firefly-iii-secret"

      env:
        IGNORE_DUPLICATE_ERRORS: "true"
        TZ: "America/Chicago"
        TRUSTED_PROXIES: "**"

    ingress:
      enabled: true
      className: "nginx"
      annotations:
        kubernetes.io/ingress.class: nginx
        cert-manager.io/cluster-issuer: cloudflare-issuer
        nginx.ingress.kubernetes.io/proxy-buffer-size: "16k"
      hosts:
        - &host firefly-import.invertedorigin.com
      tls:
       - secretName: firefly-import-tls-domain
         hosts:
           - *host